我们在开发项目时总会遇到权限问题，包括页面的权限，数据的权限，甚至按钮级的权限，
根据不同的用户身份，登录状态，看到的界面会不一样，操作也不一样

我今天会从一个场景举例，和大家探讨一下在小程序中如何去配置权限，怎么去用这个权限，以及在哪里去用？

我们以具体的场景来说，拿我们现在的小程序举例
登录身份：普通用户、业务员
业务员呢，他是可以切换多个客户的门店，可以筛选，不能下单，不能编辑门店等等，购物车看不了，账单页面没有权限

用户呢，他只可以切换自己的门店，没有筛选功能，可以下单，可以编辑门店等等

门店状态：未绑定 审核中 审核通过
未绑定、审核中的：看不到价格，加不了购物车
审核通过，可看到价格，可加购物车

页面权限：账单页面没有权限
数据、按钮权限：价格是否可见，商品的添加操作是否可执行

如果我们在每个页面中去做处理，不仅会写很多代码，而且不灵活，稍微需要改动一点，就要涉及到很多的地方
以后查看代码也不易懂，也就是前期偷懒省事，后期痛苦不堪

所以我们应该要有一个配置文件来配置这些权限开关：比如

页面配置文件
{
    "user": {
        "home": true,
        "bill" : true
    },
    "salesman: {
        "home" true,
        "bill": false
    }
}

数据配置文件
{
     "user": {
        "price": true,
        "pay" : true
    },
    "salesman: {
        "price" true,
        "pay": false
    }
}

function getAuth(identify, page) {
    // 取到权限
}

function updateAuth() {
    // 根据身份，页面，门店状态等等来更新权限
}



<b>讲到这里，询问大家有没有疑问？可不可以？</b>

没问题继续往下说

当我们能拿到权限值后，如何去用，在哪里去用呢？

像我们后台做页面权限的时候，根据登录身份来动态生成用户的可访问的路由列表，
用户输了一个不对的路径我们会跳404
或者我们还可以做一个通用的错误页面，如果匹配不到，让他跳到这个页面

<b>询问龙哥，对不对？</b>

但小程序做不到这样，它没有办法去动态生成路由列表，也没办法去匹配到其他的页面

但像下面这种情况是可以做的：
像我们的后台，当跳转到某个页面时，如果这个页面用户没有办法去访问它本来的内容，需要展示空白页面或者给它提示，可以在render函数中用那种条件语句的写法
render() {
    return 
    {
        this.state.hasAuth ? <div></div> : <empty></empty>
    }
}
也可以在页面将要挂载的时候，去重写render函数
render() {
    return 
    {
        <empty></empty>
    }
}

第一种，需要在当前页面类中，先去获取权限，再更新state中的值，来重新渲染页面
第二种，可以借助高阶组件，在页面将要挂载前，去做一些事，比如获取权限，如果有权限，正常返回这个组件，如果没有权限，重写组件的render函数

<b>询问龙哥是否正确？</b>

第一种就是你需要在每个需要进行判断权限的页面都要写一遍，还会在state中设置很多的变量，不好
第二种相对于第一种好点，但是小程序没有办法去重写render函数，它所有页面的布局都是在模板文件wxml中写好的
不过呢，我们也可以用高阶组件的思想去封装下Page构造器，可以在它的onShow，onLoad方法中做一些自己的事，比如打印日志等

这个龙哥之前说过，我就不细说了。

function withSubscription(Page, vals) {
    let result = Object.assign({}, Page);
    result.onLoad = function(...vals) {
        console.log('log');
        Page.onLoad.call(this, ...vals)
    }
    return result;
}

const GlobalPage = withSubscription(Page, data);

后来尝试了另一种方式，写一个组件 Auth

在所有需要用到权限控制的地方，都用Auth组件包一下

对于整个页面的，在最外层包一下
<auth>
...
</auth>

对于单个元素的，在该元素外面包一下
<auth>
    <div>
        <auth key="price"><p>{{showPrice ? '14.1元' ： '登录后才能见到价格'}}</p></auth>
    </div>
<auth>

把所有的权限判断都放到Auth组件中去做，组件再通过事件来告诉内部子元素你如何展示

在Auth组件中，是可以知道当前页面路径的，也知道用户身份，门店状态等等，所以页面级的权限是知道的
如果有权限我就正常显示子组件，如果没有权限，我就显示另外的元素，比如弹窗等等自定义的元素

那对于单个元素的，auth组件就从配置文件取到price的权限，通过事件来告诉子组件，子组件更新showPrice的值，界面刷新



